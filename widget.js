function loadJSON(k,def){try{return JSON.parse(localStorage.getItem(k))||def}catch{return def}}function timeHM(t){const[h,m]=t.split(':').map(n=>parseInt(n,10));const d=new Date();d.setHours(h,m,0,0);return d}function fmtHM(d){return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}function durFmt(ms){const s=Math.max(0,Math.floor(ms/1000));const mm=Math.floor(s/60),ss=s%60,hh=Math.floor(mm/60),mm2=mm%60;return hh>0?`${hh}:${String(mm2).padStart(2,'0')}:${String(ss).padStart(2,'0')}`:`${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`}const prefs=loadJSON('bb.prefs.v3_1',{});const tplMonThu=[['1','Period 1','07:20','08:10'],['2','Period 2','08:15','09:05'],['hawk','Hawk Time','09:10','09:46'],['3','Period 3','09:51','10:41'],['4A','4A','10:41','11:11'],['4','4','11:16','11:36'],['4B','4B','11:36','12:06'],['5','5','12:11','12:31'],['5C','5C','12:31','13:01'],['6','6','13:06','13:56'],['7','7','14:01','14:51']], tplFri=[['1','Period 1','07:20','08:07'],['2','Period 2','08:12','09:02'],['3','Period 3','09:07','09:54'],['4A','4A','09:54','10:24'],['4','4','10:29','10:46'],['4B','4B','10:46','11:16'],['5','5','11:21','11:38'],['5C','5C','11:38','12:08'],['6','6','12:13','13:00'],['7','7','13:05','13:52']];function merged(isFri){const base=(isFri?tplFri:tplMonThu).map(([id,n,s,e])=>({id,n,s,e}));const L=prefs.lunch;const out=[];const get=id=>base.find(x=>x.id===id);const push=(id,n,s,e)=>out.push({id,n,s,e});['1','2','hawk','3'].forEach(id=>{const b=get(id);if(b)push(b.id,b.n,b.s,b.e)});const b4a=get('4A'),b4=get('4'),b4b=get('4B'),b5=get('5'),b5c=get('5C');if(L==='4A'){if(b4a)push('4A','Lunch',b4a.s,b4a.e);if(b4&&b4b)push('4','4',b4.s,b4b.e);if(b5&&b5c)push('5','5',b5.s,b5c.e)}else if(L==='4B'){if(b4a&&b4)push('4','4',b4a.s,b4.e);if(b4b)push('4B','Lunch',b4b.s,b4b.e);if(b5&&b5c)push('5','5',b5.s,b5c.e)}else if(L==='5C'){if(b4a&&b4b)push('4','4',b4a.s,b4b.e);if(b5)push('5','5',b5.s,b5.e);if(b5c)push('5C','Lunch',b5c.s,b5c.e)}else{['4A','4','4B','5','5C'].forEach(id=>{const b=get(id);if(b)push(b.id,b.n,b.s,b.e)})}['6','7'].forEach(id=>{const b=get(id);if(b)push(id,b.n,b.s,b.e)});return out}function update(){const now=new Date();const blocks=merged(now.getDay()===5).map(b=>({...b,startD:timeHM(b.s),endD:timeHM(b.e)})).sort((a,b)=>a.startD-b.startD);let cur=null,nxt=null;for(const b of blocks){if(now>=b.startD&&now<b.endD){cur=b;break}if(now<b.startD){nxt=b;break}}const cnt=document.getElementById('cnt'),sub=document.getElementById('sub');if(cur){const left=cur.endD-now;cnt.textContent=durFmt(left);sub.textContent='Ends '+fmtHM(cur.endD)}else if(nxt){const until=nxt.startD-now;cnt.textContent=durFmt(until);sub.textContent='Next '+(nxt.n||nxt.id)+' @ '+fmtHM(nxt.startD)}else{cnt.textContent='--:--';sub.textContent='â€”'}}update();setInterval(update,1000);